(()=>{"use strict";function e({channel:e}){this._EventEmitter__channel=e}function t(){e.call(this,t._EventEmitter__Router),window.addEventListener("popstate",(e=>{this._Router__handleHashChange(e.state)})),setTimeout((()=>{this._Router__handleHashChange()}))}e.prototype={_emitEvents:function(e){return dispatchEvent(new CustomEvent(this._EventEmitter__channel,{cancellable:!0,detail:e}))}},t._EventEmitter__Router={channel:"app-route"},t.prototype={_Router__handleHashChange:function(e){if(!e)try{let t=window.location.hash;e=t?decodeURIComponent(t.substring(1)).split(";"):[]}catch(t){e=[]}return this._emitEvents({route:e})},get goTo(){return function(e){let t=encodeURIComponent(e.join(";"));window.history.pushState(e,"","#"+t),this._Router__handleHashChange(e)}.bind(this)},get back(){return function(){window.history.back()}.bind(this)},get resend(){return function(){this._Router__handleHashChange()}.bind(this)}},Object.setPrototypeOf(t.prototype,e.prototype);const n=new t;function a({kind:e,strDate:t,strDescription:n,strTime:a,userInitiator:r,cursor:s},i,o){if("cursor_move"===e){if(r&&r===o)return({patchCursor:e})=>e(parseInt(s))}else{let s=Date.parse(t);if(isNaN(s)||!a)return;if("create"===e){let e;return r&&r!==o&&(e=i),({createEvent:r})=>r([t,a],{description:n,time:e})}if("cancel"===e)return({deleteEvent:e})=>e([t,a])}}function r({toCancel:e,toCreate:t,userInitiator:n},r,s){{if(!e)return;let{strDate:t,strTime:n}=e,a=Date.parse(t);if(isNaN(a)||!n)return}{if(!t)return;let{strDate:e,strTime:n}=t,a=Date.parse(e);if(isNaN(a)||!n)return}let i=a(e,r,s),o=a(t,r,s);return e=>{i(e),o(e)}}async function s({from:e,password:t,newEvent:n}){let a={Accept:"application/json","X-Csrf-Token":window.__csrfToken};t&&(a.Authentication=btoa(t));let r,s="GET";n&&(s="POST",r=JSON.stringify(n),a["Content-Type"]="application/json");let i="/send_event.php?from="+parseInt(e),o=await fetch(i,{method:s,headers:a,body:r});if(200!==o.status)throw o.status;return o}function i(){e.call(this,i._EventEmitter__Backend),this._Backend__view=new Map,this._Backend__newEvents=new Set,this._Backend__userCursor=0,this._Backend__isBusy=!1,this._Backend__lastUpdateTimestamp=0,this._Backend__lastInError=!1}customElements.define("app-close-button",class extends HTMLElement{constructor(){super()}connectedCallback(){let{back:e}=n;this.firstElementChild.onclick=e}}),i._EventEmitter__Backend={channel:"app-calendar"},i.prototype={_Backend__deleteEvent:function([e,t]){let n=this._Backend__view;if(n.has(e)){let a=n.get(e);a.has(t)&&a.delete(t),0===a.size&&n.delete(e)}},_Backend__createEvent:function([e,t],{description:n,time:a}){let r=this._Backend__userCursor,s=this._Backend__view,i=this._Backend__newEvents,o={description:n,unread:a&&a>r};s.has(e)||s.set(e,new Map),s=s.get(e),s.set(t,o),o.unread&&i.add({time:a,strDate:e,strTime:t})},_Backend__patchCursor:function(e){if(!isNaN(e)){let t=this._Backend__newEvents,n=this._Backend__view;e=Math.max(this._Backend__userCursor,e);for(let a of t)if(a.time<e){let{strDate:e,strTime:r}=a;if(n.has(e)){let t=n.get(e);t.has(r)&&(t.get(r).unread=!1)}t.delete(a)}}},get state(){return this._Backend__lastUpdateTimestamp||this._Backend__lastInError||this.update({},(()=>{})).then((e=>{e&&(this._Backend__lastUpdateTimestamp=Date.now())})),{view:this._Backend__view,newEvents:[...new Set([...this._Backend__newEvents].map((({strTime:e,strDate:t})=>`${t} ${e}`)))].map((e=>{let t=e.indexOf(" ");return{strDate:e.substring(0,t),strTime:e.substring(t+1)}})),markRead:this.markRead,createEvent:this.createEvent,editEvent:this.editEvent,cancelEvent:this.cancelEvent}},get update(){return async function({password:e,newEvent:t},i){try{if(this._Backend__isBusy)return!1;this._Backend__isBusy=!0;try{try{var o=await function(e,t){function n(e){if(!e)return;let n=window.localStorage.getItem("userName"),s=[];for(let t of e)if(t){let[e,i]=t;if(i){let t;1===e.version?t=a(e,i,n):2===e.version&&(t=r(e,i,n)),t&&s.push(t)}}for(let e of s)e(t)}return s(e).then((e=>()=>async function(e){let t,a;for(;;){if(a=e.headers.get("x-next-page-time")||0,!a)return n(await e.json()),t;t=a,[e]=await Promise.all([s({from:t}),e.json().then(n)])}}(e)))}({password:e,newEvent:t,from:this._Backend__userCursor},{deleteEvent:this._Backend__deleteEvent.bind(this),createEvent:this._Backend__createEvent.bind(this),patchCursor:this._Backend__patchCursor.bind(this)});this._Backend__lastInError=!1}catch(e){return 401===e?(this._Backend__lastInError=!0,n.goTo(["authentication"])):i&&i(e),!1}let l=await o();this._Backend__userCursor=l||this._Backend__userCursor;for(let e of this._Backend__newEvents){let{strDate:t,strTime:n}=e,a=this._Backend__view;a.has(t)&&a.get(t).has(n)||this._Backend__newEvents.delete(e)}return!0}finally{this._Backend__isBusy=!1,this._emitEvents(this.view)}}catch(e){console.error(e)}}.bind(this)},get createEvent(){return async function({strTime:e,strDate:t,strDescription:n}){let a={strTime:e,strDate:t,strDescription:n,userInitiator:window.localStorage.getItem("userName"),kind:"create",version:1};return this.update({newEvent:a})}.bind(this)},get cancelEvent(){return async function({strDate:e,strTime:t}){let n={strDate:e,strTime:t,userInitiator:window.localStorage.getItem("userName"),version:1,kind:"cancel"};return this.update({newEvent:n})}.bind(this)},get editEvent(){return async function({toCancel:e,toCreate:t}){let n=window.localStorage.getItem("userName"),a={toCreate:t=(({strTime:e,strDate:t,strDescription:a})=>({strTime:e,strDate:t,strDescription:a,userInitiator:n,version:1,kind:"create"}))(t),toCancel:e=(({strTime:e,strDate:t})=>({strTime:e,strDate:t,version:1,kind:"cancel",userInitiator:n}))(e),userInitiator:n,version:2};return this.update({newEvent:a})}.bind(this)},get markRead(){return async function(){let e={userInitiator:window.localStorage.getItem("userName"),kind:"cursor_move",version:1,cursor:this._Backend__userCursor};return this.update({newEvent:e})}.bind(this)}},Object.setPrototypeOf(i.prototype,e.prototype);const o=new i;class l extends HTMLElement{_DateConnectedElement__listener=()=>this.repaint();constructor(){super()}connectedCallback(){window.addEventListener("app-calendar",this._DateConnectedElement__listener),this.repaint()}disconnectedCallback(){window.removeEventListener("app-calendar",this._DateConnectedElement__listener)}attributeChangedCallback(e,t,n){switch(e){case"data-strdate":this.repaint({strDate:n});break;case"data-strtime":this.repaint({strTime:n});break;case"data-todaydate":this.repaint({todayDate:n})}}repaintAttributes(e){let{strDate:t,todayDate:n,strTime:a}=e||{};return{strDate:t||this.getAttribute("data-strdate"),strTime:a||this.getAttribute("data-strtime"),todayDate:n||this.getAttribute("data-todaydate")}}repaint(e){this._repaint(this.repaintAttributes(e),o.state)}_repaint(e,{view:t,newEvents:n}){throw"Subclass should overwrite the _repaint(any, { view, newEvents }) method"}}function c(e){let t=new Date(e),n=t.getMonth()+1,a=t.getDate();return t.getFullYear()+"-"+(n<10?"0":"")+n+"-"+(a<10?"0":"")+a}function d(e){let t=new Date(e).getDay();for(;new Date(e).getDay()===t;)e+=864e5;return e}function u(e){let t=new Date(e).getDay();for(;new Date(e).getDay()===t;)e-=864e5;return e}function p(e){return Date.parse(e)}function h(e){return e.substring(8,10)}function m(e){return e.substring(5,7)}function _(e){return e.substring(0,4)}function f(e){let t;switch(m(e)){case"01":t="Janvier";break;case"02":t="Février";break;case"03":t="Mars";break;case"04":t="Avril";break;case"05":t="Main";break;case"06":t="Juin";break;case"07":t="Juillet";break;case"08":t="Août";break;case"09":t="Septembre";break;case"10":t="Octobre";break;case"11":t="Novembre";break;case"12":t="Décembre"}return t}customElements.define("app-appointments-create",class extends l{static get observedAttributes(){return["data-strdate"]}constructor(){super()}connectedCallback(){this.appendChild(document.getElementById("app-appointments-create").content.cloneNode(!0)),super.connectedCallback()}_repaint({strDate:e},{view:t,createEvent:n}){let a=this.querySelector("form"),r=this.querySelector("*[data-id=warning]");if(a){a.appointmentdate.value=e,a.onsubmit=t=>(t.preventDefault(),this.handleCreateAppointment({strDate:e,strTime:a.appointmenttime.value,strDescription:a.appointmentdescription.value},n),!1),r.classList.remove("appointment-conflict");let s=t.get(e);s&&(a.appointmenttime.onchange=e=>{s.has(e.target.value)?r.classList.add("appointment-conflict"):r.classList.remove("appointment-conflict")})}}handleCreateAppointment(e,t){let a=document.querySelector("input[type=submit]");a.disabled=!0,(async()=>{try{await t(e)&&n.back()}finally{a.disabled=!1}})()}}),customElements.define("app-appointments-edit",class extends l{static get observedAttributes(){return["data-strdate","data-strtime"]}constructor(){super()}connectedCallback(){this.appendChild(document.getElementById("app-appointments-edit").content.cloneNode(!0)),super.connectedCallback()}_repaint({strDate:e,strTime:t},{editEvent:n,cancelEvent:a,view:r}){let s=this.querySelector("form");{if(!e||!t)return;if(!r)return;let n=r.get(e);if(!n)return;let a=n.get(t);if(!a)return;var{description:i}=a}e&&t&&i&&s&&(s.appointmentdate.value=e,s.appointmenttime.value=t,s.appointmentdescription.value=i,s.cancelOnly.onchange=n=>{n.target.checked?(s.appointmentdate.value=e,s.appointmenttime.value=t,s.appointmentdescription.value=i,s.appointmentdate.disabled=!0,s.appointmenttime.disabled=!0,s.appointmentdescription.disabled=!0):(s.appointmentdate.disabled=!1,s.appointmenttime.disabled=!1,s.appointmentdescription.disabled=!1)},s.onsubmit=r=>(r.preventDefault(),s.cancelOnly.checked?this.handleEditCalendar({strDate:e,strTime:t},a):this.handleEditCalendar({toCancel:{strDate:e,strTime:t},toCreate:{strDate:s.appointmentdate.value,strTime:s.appointmenttime.value,strDescription:s.appointmentdescription.value}},n),!1))}handleEditCalendar(e,t){let a=document.querySelector("input[type=submit]");a.disabled=!0,(async()=>{try{await t(e)&&n.back()}finally{a.disabled=!1}})()}}),customElements.define("app-appointments-list",class extends l{static get observedAttributes(){return["data-strdate"]}constructor(){super()}connectedCallback(){this.appendChild(document.getElementById("app-appointments-list").content.cloneNode(!0)),super.connectedCallback()}_repaint({strDate:e},{view:t,newEvents:a}){let r=this.querySelector("footer input[type=button]");r&&(e?(r.onclick=()=>n.goTo(["appointments","new",e]),r.disabled=!1):(r.onclick=()=>{},r.disabled=!0));let s=this.querySelector("div.grid");if(s){s.innerHTML="";let n=t.get(e)||[];0===n.length?this.repaintWhenNoElements(s):this.repaintWhenElements(s,e,n)}}repaintWhenNoElements(e){let t=this.querySelector("template[data-on=no-elements]");e.appendChild(t.content.cloneNode(!0))}repaintWhenElements(e,t,a){let r=this.querySelector("template[data-on=some-element]"),s=[...a.keys()];function i(e,{description:t,unread:n}){return{strTime:e,strDescription:t,isUnread:n?"*":""}}s.sort();for(let o of s){let s=a.get(o);e.appendChild(r.content.cloneNode(!0));let l=e.lastElementChild,c=i(o,s);for(let e of l.querySelectorAll("slot"))e.textContent=c[e.getAttribute("name")];l.onclick=()=>n.goTo(["appointments","edit",t,o])}}}),customElements.define("app-appointments-unread-list",class extends l{static get observedAttributes(){return[]}constructor(){super()}connectedCallback(){this.appendChild(document.getElementById("app-appointments-unread-list").content.cloneNode(!0)),super.connectedCallback()}_repaint({todayDate:e},{view:t,newEvents:n}){let a=this.querySelector("footer input[type=button]");a&&(a.onclick=()=>{});let r=this.querySelector("div.grid");r&&(r.innerHTML="",console.log(n),0===n.length?this.repaintWhenNoElements(r):this.repaintWhenElements(r,t,[...n],e))}repaintWhenNoElements(e){let t=this.querySelector("template[data-on=no-elements]");e.appendChild(t.content.cloneNode(!0)),this.querySelector("footer").classList.add("hidden")}repaintWhenElements(e,t,a,r){let s=r?_(r):null,i=this.querySelector("template[data-on=some-element]");function l(e,n){let a=t;return a.has(e)&&(a=a.get(e),a.has(n))?a.get(n):null}a.sort((function(e,t){return e.strDate<t.strDate?-1:e.strDate>t.strDate?1:e.strTime<t.strTime?-1:e.strTime>t.strTime?1:0}));for(let{strDate:t,strTime:o}of a){let a=l(t,o);if(!a)continue;e.appendChild(i.content.cloneNode(!0));let c=e.lastElementChild,d={"strDate-day":h(t),"strDate-month":f(t),"strDate-year":s&&r<t?_(t):"",strTime:o,strDescription:a.description};for(let e of c.querySelectorAll("slot"))e.textContent=d[e.getAttribute("name")];c.onclick=()=>n.goTo(["appointments","edit",t,o])}let c=this.querySelector("footer");c.classList.remove("hidden"),c.querySelector("*").onclick=function(){this.disabled=!0,o.markRead().finally((()=>{this.disabled=!1}))}}});class v extends HTMLElement{constructor(){super()}}function b(e,t){customElements.define(e,t)}b("app-authentication",class extends v{constructor(){super()}connectedCallback(){this.appendChild(document.getElementById("app-authentication").content.cloneNode(!0)),this.querySelector("form").onsubmit=e=>(e.preventDefault(),this.onSubmitForm(),!1)}onSubmitForm(){let e=this.querySelector("form"),t=this.querySelector("*[data-on=message]"),a=e.querySelector("input[type=submit]"),r=e.passwordField.value||"";(async()=>{try{a.disabled=!0,await o.update({password:r},(n=>{t.textContent="Generic error message",e.passwordField.focus(),e.passwordField.select()}))&&n.back()}catch(e){console.error(e)}finally{e.disabled=!1}})()}}),b("app-calendar",class extends v{__currentState={startDate:null,nbrWeek:null};constructor(){super()}connectedCallback(){this.appendChild(document.getElementById("app-calendar").content.cloneNode(!0));let e=this.querySelector("form");e.nbrWeeks.onchange=e=>(e.preventDefault(),this.handleNbrWeekChange(e.target.value),!1),e.startDate.onchange=e=>(e.preventDefault(),this.handleStartDateChange(e.target.value),!1),e.prevWeek.onclick=e=>(e.preventDefault(),this.handleMoveWeekBackward(),!1),e.nextWeek.onclick=e=>(e.preventDefault(),this.handleMoveWeekForward(),!1),e.startDate.value||(e.startDate.value=c(Date.now())),this.handleNbrWeekChange(e.nbrWeeks.value),this.handleStartDateChange(e.startDate.value),this.querySelector("*[data-id=all-unread]").onclick=()=>n.goTo(["appointments","unread"])}handleMoveWeekForward(){if(this.__currentState.startDate){let e=p(this.__currentState.startDate);for(let t=0;t<7;t++)e=d(e);this.__currentState.startDate=c(e),this.handleStateChange()}}handleMoveWeekBackward(){if(this.__currentState.startDate){let e=p(this.__currentState.startDate);for(let t=0;t<7;t++)e=u(e);this.__currentState.startDate=c(e),this.handleStateChange()}}handleNbrWeekChange(e){this.__currentState.nbrWeek!==e&&(this.__currentState.nbrWeek=e,this.handleStateChange())}handleStartDateChange(e){this.__currentState.startDate!==e&&(this.__currentState.startDate=e,this.handleStateChange())}handleStateChange(){let{nbrWeek:e,startDate:t}=this.__currentState;{let e=this.querySelector("form");e.startDate&&t&&(e.startDate.value=t)}if(e&&t){let n=this.querySelector("tbody");n.innerHTML="";let a=this.querySelector("table template"),r=function(e){for(;1!==new Date(e).getDay();)e-=864e5;return e}(p(t));for(let t=0;t<e;t++){let e=document.createElement("tr");n.appendChild(e);for(let t=0;t<7;t++){let t=document.createElement("td");e.appendChild(t);let n=a.content.cloneNode(!0);t.appendChild(n),n=t.firstElementChild,n.setAttribute("data-strdate",c(r)),n.setAttribute("data-todaydate",c(Date.now())),r=d(r)}}}}}),customElements.define("app-calendar-cell",class extends l{static get observedAttributes(){return["data-strdate","data-todaydate"]}_AppCalendarCell__listener=this.handleClick.bind(this);constructor(){super()}connectedCallback(){super.connectedCallback(),this.parentElement.addEventListener("click",this._AppCalendarCell__listener)}disconnectedCallback(){super.disconnectedCallback(),this.parentElement.removeEventListener("click",this._AppCalendarCell__listener)}handleClick(){let{strDate:e}=this.repaintAttributes();e&&n.goTo(["appointments",e])}_repaint({strDate:e,todayDate:t},{view:n,newEvents:a}){if(e){let r=this.querySelector("span"),s=r.querySelector(".content"),i=r.querySelector(".month");s.textContent=h(e),i.textContent=m(e),s.classList.remove("nonempty");for(let t of a)if(e===t.strDate){s.classList.add("nonempty");break}n.get(e)&&(s.textContent+="*"),e===t?r.classList.add("today"):r.classList.remove("today"),t&&m(t)===m(e)?r.classList.add("in-month"):r.classList.remove("in-month")}}}),b("app-identification",class extends v{constructor(){super()}connectedCallback(){var e,t;if(this.appendChild(document.getElementById("app-identification").content.cloneNode(!0)),(e=this.querySelector("form")).onsubmit=t=>{t.preventDefault();let a=e.userId.value;return window.localStorage.setItem("userName",a),n.goTo([]),!1},t=window.localStorage.getItem("userName"))for(let n of e.querySelectorAll("input[name=userId]"))n.value===t&&(n.checked=!0)}}),customElements.define("app-main",class extends HTMLElement{__listener=e=>this.handleRoute(e.detail)?e.preventDefault():void 0;constructor(){super()}connectedCallback(){window.addEventListener("app-route",this.__listener),n.resend()}disconnectedCallback(){window.removeEventListener("app-route",this.__listener)}handleRoute({route:e}){var t;if(0===e.length)t=window.localStorage.getItem("userName")?document.createElement("app-calendar"):document.createElement("app-identification");else{var[n]=e;if("authentication"===n)t=document.createElement("app-authentication");else if("appointments"===n)if(2===e.length){let[n,a]=e;if("unread"===a)t=document.createElement("app-appointments-unread-list");else{let e=a;(t=document.createElement("app-appointments-list")).setAttribute("data-strDate",e)}}else{var[a,r]=e;if("new"===r){var[a,a,s]=e;(t=document.createElement("app-appointments-create")).setAttribute("data-strDate",s)}else if("edit"===r){var[a,a,s,i]=e;(t=document.createElement("app-appointments-edit")).setAttribute("data-strdate",s),t.setAttribute("data-strtime",i)}}}return!!t&&(this.firstElementChild.innerHTML="",this.firstElementChild.append(t),!0)}})})();