(()=>{var e={819:()=>{customElements.define("app-long-french-time",class extends HTMLElement{constructor(){super()}static get observedAttributes(){return["strtime"]}attributeChangedCallback(e,t,r){if("strtime"===e&&r){let e;switch(r){case"fullday":e="Toute la journée";break;case"afternoon":e="L'après-midi";break;case"morning":e="Le matin";break;default:e=`À ${r}`}this.textContent=e}else this.innerHTML=""}})}},t={};function r(n){var a=t[n];if(void 0!==a)return a.exports;var i=t[n]={exports:{}};return e[n](i,i.exports,r),i.exports}(()=>{"use strict";function e(e){return new Date(e).getUTCDay()}function t(e){return new Date(e).toISOString().substring(0,10)}function n(t){let r=e(t);for(;e(t)===r;)t+=432e5;return t}function a(t){let r=e(t);for(t+=5184e5;e(t)!==r;)t+=432e5;return t}function i(t){let r=e(t);for(t-=5184e5;e(t)!==r;)t-=432e5;return t}function s(e){return Date.parse(e)}function o(e){return e.substring(8,10)}function l(e){return e.substring(5,7)}function c(e,t){return e.strDate===t.strDate?function(e,t){return e==t?0:"fullday"==e?-1:"fullday"==t?1:"morning"==e?-1:"morning"==t?1:"afternoon"==e?t<"12:00"?1:-1:"afternoon"==t?e<"12:00"?-1:1:e<=t?-1:1}(e.strTime,t.strTime):e.strDate<=t.strDate?-1:1}function u({kind:e,strDate:t,strDescription:r,strTime:n,userInitiator:a,cursor:i},s,o){if("cursor_move"===e){if(a&&a===o)return({patchCursor:e})=>e(parseInt(i))}else{let i=Date.parse(t);if(isNaN(i)||!n)return;if("create"===e){let e;return a&&a!==o&&(e=s),({createEvent:a})=>a([t,n],{description:r,time:e})}if("cancel"===e)return({deleteEvent:e})=>e([t,n])}}function d({toCancel:e,toCreate:t},r,n){{if(!e)return;let{strDate:t,strTime:r}=e,n=Date.parse(t);if(isNaN(n)||!r)return}{if(!t)return;let{strDate:e,strTime:r}=t,n=Date.parse(e);if(isNaN(n)||!r)return}let a=u(e,r,n),i=u(t,r,n);return e=>{a(e),i(e)}}async function h({from:e,password:t,newEvent:r}){let n={Accept:"application/json","X-Csrf-Token":window.__csrfToken};t&&(n.Authentication=btoa(t));let a,i="GET";r&&(i="POST",a=JSON.stringify(r),n["Content-Type"]="application/json");let s="/send_event.php?from="+parseInt(e),o=await fetch(s,{method:i,headers:n,body:a});if(200!==o.status)throw{errorCode:o.status,authenticationDelay:o.headers.get("X-Authentication-Delay"),errorMessage:await o.json()};return o}function f(){this._Backend__view=new Map,this._Backend__newEvents=new Set,this._Backend__userCursor=0,this._Backend__isBusy=!1,this._Backend__lastUpdateTimestamp=0}f.prototype={_Backend__getState:function(){if(!this.authentifiedUser.userName)throw{errorMessage:"Utilisateur non identifié",errorCode:403};return{view:this._Backend__view,newEvents:[...new Set([...this._Backend__newEvents].map((({strTime:e,strDate:t})=>`${t} ${e}`)))].map((e=>{let t=e.indexOf(" ");return{strDate:e.substring(0,t),strTime:e.substring(t+1)}}))}},_Backend__deleteEvent:function([e,t]){let r=this._Backend__view;if(r.has(e)){let n=r.get(e);n.has(t)&&n.delete(t),0===n.size&&r.delete(e)}},_Backend__createEvent:function([e,t],{description:r,time:n}){let a=this._Backend__userCursor,i=this._Backend__view,s=this._Backend__newEvents,o={description:r,unread:n&&n>a};i.has(e)||i.set(e,new Map),i=i.get(e),i.set(t,o),o.unread&&s.add({time:n,strDate:e,strTime:t})},_Backend__markEventsAsRead:function(e){let t=this._Backend__newEvents,r=this._Backend__view;for(let n of t)if(e(n)){let{strDate:e,strTime:a}=n,i=r.get(e),s=i?i.get(a):void 0;s&&(s.unread=!1),t.delete(n)}},_Backend__patchCursor:function(e){isNaN(e)||(e=Math.max(this._Backend__userCursor,e),this._Backend__markEventsAsRead((t=>t.time<=e)))},_Backend__checkIfAppointmentBelongsToView:function({strTime:e,strDate:t}){let r=this._Backend__view;return r.has(t)&&r.get(t).has(e)},_Backend__update:async function({password:e,newEvent:r}){try{if(this._Backend__isBusy)return!1;this._Backend__isBusy=!0;try{var n=await function(e,t){function r(e){if(!e)return;let r=window.localStorage.getItem("userName"),n=[];for(let t of e)if(t){let[e,a]=t;if(a){let t;1===e.version?t=u(e,a,r):2===e.version&&(t=d(e,a,r)),t&&n.push(t)}}for(let e of n)e(t)}return h(e).then((e=>()=>async function(e){let t,n;for(;;){if(n=e.headers.get("x-next-page-time")||0,!n)return r(await e.json()),t;t=n,[e]=await Promise.all([h({from:t}),e.json().then(r)])}}(e)))}({password:e,newEvent:r,from:this._Backend__userCursor},{deleteEvent:this._Backend__deleteEvent.bind(this),createEvent:this._Backend__createEvent.bind(this),patchCursor:this._Backend__patchCursor.bind(this)});let a=await n();this._Backend__userCursor=a||this._Backend__userCursor;const i=t(Date.now());return this._Backend__markEventsAsRead((e=>e.strDate<i)),!0}finally{this._Backend__isBusy=!1}}catch(e){throw console.error(e),e}},get state(){return new Promise(((e,t)=>{let r=Date.now();(async()=>{if(!this._Backend__lastUpdateTimestamp||this._Backend__lastUpdateTimestamp<r-3e4)try{await this._Backend__update({}),this._Backend__lastUpdateTimestamp=r}catch(e){t(e)}try{e(this._Backend__getState())}catch(e){t(e)}})()}))},get authentifiedUser(){return{userName:localStorage.getItem("userName")||void 0}},get authentify(){return async function({password:e,userName:t}){return t?localStorage.setItem("userName",t):localStorage.removeItem("userName"),this._Backend__update({password:e})}.bind(this)},get createEvent(){return async function({strTime:e,strDate:t,strDescription:r}){let n={strTime:e,strDate:t,strDescription:r,userInitiator:window.localStorage.getItem("userName"),kind:"create",version:1};return this._Backend__update({newEvent:n})}.bind(this)},get cancelEvent(){return async function({strDate:e,strTime:t}){let r={strDate:e,strTime:t,userInitiator:window.localStorage.getItem("userName"),version:1,kind:"cancel"};return this._Backend__update({newEvent:r})}.bind(this)},get editEvent(){return async function({toCancel:e,toCreate:t}){let r=window.localStorage.getItem("userName"),n={toCreate:t=(({strTime:e,strDate:t,strDescription:n})=>({strTime:e,strDate:t,strDescription:n,userInitiator:r,version:1,kind:"create"}))(t),toCancel:e=(({strTime:e,strDate:t})=>({strTime:e,strDate:t,version:1,kind:"cancel",userInitiator:r}))(e),userInitiator:r,version:2};return this._Backend__update({newEvent:n})}.bind(this)},get markRead(){return async function(){let e={userInitiator:window.localStorage.getItem("userName"),kind:"cursor_move",version:1,cursor:this._Backend__userCursor};return this._Backend__update({newEvent:e})}.bind(this)}};const m=new f;customElements.define("app-long-french-date",class extends HTMLElement{constructor(){super()}static get observedAttributes(){return["strdate"]}attributeChangedCallback(e,t,r){if("strdate"===e&&r){let e;switch(l(r)){case"01":e="Janvier";break;case"02":e="Février";break;case"03":e="Mars";break;case"04":e="Avril";break;case"05":e="Mai";break;case"06":e="Juin";break;case"07":e="Juillet";break;case"08":e="Août";break;case"09":e="Septembre";break;case"10":e="Octobre";break;case"11":e="Novembre";break;case"12":e="Décembre"}let t=o(r);if(1==t){let t=document.createTextNode("1"),r=document.createElement("sup");r.textContent="er";let n=document.createTextNode(" "+e);this.appendChild(t),this.appendChild(r),this.appendChild(n)}else{switch(t){case"01":t="1er";break;case"02":t="2";break;case"03":t="3";break;case"04":t="4";break;case"05":t="5";break;case"06":t="6";break;case"07":t="7";break;case"08":t="8";break;case"09":t="9"}this.textContent=`Le ${t} ${e}`}}else this.innerHTML=""}}),r(819),customElements.define("app-day-two-digits",class extends HTMLElement{constructor(){super()}static get observedAttributes(){return["strdate"]}connectedCallack(){console.log("OK")}attributeChangedCallback(e,t,r){"strdate"===e&&r?this.textContent=o(r):this.innerHTML=""}}),customElements.define("app-month-two-digits",class extends HTMLElement{constructor(){super()}static get observedAttributes(){return["strdate"]}attributeChangedCallback(e,t,r){"strdate"==e&&r?this.textContent=l(r):this.innerHTML=""}});const p=(()=>{let e=new Map;return e.set("click","handleClick"),e.set("submit","handleSubmit"),e.set("change","handleChange"),e})(),g=10,_="{",v="}",y="#",b="?",w=":",k="$",D="%",T="|",E='"',C="/",S="data-uuid",B=/\s\s+/g;function*O(e,t,r,n){t||(yield"");let a=e.variable;if(null!=e.slice)yield e.slice;else if(e.root)for(let a of e.children)yield*O(a,t,r,n);else if(e.section)if(a){if(Object.hasOwn(t,a)&&(t=t[a]))if("function"==typeof t[Symbol.iterator]){n.push(0);for(let a of t){for(let t of e.children)yield*O(t,a,r,n);n[n.length-1]+=1}n.pop()}else for(let a of e.children)yield*O(a,t,r,n)}else{if(r)throw"Nested identification blocks are forbidden";let a=`${r=e.elementUuid}-${n.join("_")}`;yield` ${S}="${a}" `;for(let a of e.children)yield*O(a,t,r,n)}else if(e.positiveConditional){if(a&&Object.hasOwn(t,a)&&t[a]){r||n.push("t");for(let a of e.children)yield*O(a,t,r,n);r||n.pop()}}else if(e.negativeConditional){if(a&&Object.hasOwn(t,a)&&!t[a]){r||n.push("f");for(let a of e.children)yield*O(a,t,r,n);r||n.pop()}}else if(e.event){if(a){let e=p.get(a);if(e&&Object.hasOwn(t,e)){let i=t[e],s=`${r}-${n.join("_")}`;yield[s,e=>e.addEventListener(a,i),e=>e.removeEventListener(a,i)]}}}else if(e.textContent){if(a&&Object.hasOwn(t,a)&&t[a]){let e=`${r}-${n.join("_")}`,i=t[a]||"";yield[e,e=>e.textContent=i,e=>e.textContent=""]}}else{if(!e.pipe)throw"Kawabunga, we are on a node we cannot handle?";{let i=`${r}-${n.join("_")}`,s=e.pipe;if("class"===s){let r=null;null==e.value?a&&Object.hasOwn(t,a)&&t[a]&&(r=a):r=e.value,null!=r&&(yield[i,e=>e.classList.add(r),e=>e.classList.remove(r)])}else{let r=null;null==e.value?a&&Object.hasOwn(t,a)&&t[a]&&(r=t[a]):r=e.value,null!=r&&(yield[i,e=>e.setAttribute(s,r),e=>e.removeAttribute(s)])}}}}function x(e,t){let r=function(e,t){let r={children:[],root:!0},n=new Set(t),a=0,i=[r];for(;a<e.length;){if(i.length>=g)throw"Template is too deep";let t=e.indexOf(_,a),r=i.pop();if(t>=0){if(a+1<t){let n=e.substring(a,t).replace(B," ");e:{if(" "===n){if(r.elementUuid)break e;for(let e=i.length;--e>=0;)if(i[e].elementUuid)break e}r.children.push({slice:n})}}let s=e.indexOf(v,t);if(-1==s){let r=0;for(let n of e.substring(0,t))"\n"==n&&(r+=1);throw`No closing symbol found for opening block; around line ${r}`}let o=e.substring(t+_.length+1,s).trim();switch(e[t+_.length]){case y:{let e={section:!0,variable:o,children:[]};if(!o){let t;do{t="uuid"+parseInt(1e8*Math.random())}while(n.has(t));n.add(t),e.elementUuid=t}r.children.push(e),i.push(r),i.push(e)}break;case b:{let e={positiveConditional:!0,variable:o,children:[]};r.children.push(e),i.push(r),i.push(e)}break;case w:{let e={negativeConditional:!0,variable:o,children:[]};r.children.push(e),i.push(r),i.push(e)}break;case D:r.children.push({event:!0,variable:o}),i.push(r);break;case k:r.children.push({textContent:!0,variable:o}),i.push(r);break;case C:break;default:{let n=e.substring(t+_.length,s).trim(),a=n.indexOf(T);if(-1==a){let r=0;for(let n of e.substring(0,t))"\n"==n&&(r+=1);throw`No pipe delimiter found, though we reach the end of potential blocks; around line ${r}`}let o,l=n.substring(a+T.length,n.length).trim();n=n.substring(0,a).trim(),o=n.startsWith(E)?{value:n.substring(1,n.length).trim(),pipe:l}:{variable:n,pipe:l},r.children.push(o),i.push(r)}}a=s+v.length}else r.children.push({slice:e.substring(a,e.length).replace(B," ")}),a=e.length}return r}(e,t);return function*(e,t){let n=new Map;{let a=[];for(let e of O(r,t,void 0,[]))if("string"==typeof e)a.push(e);else{let[t,r,a]=e;n.has(t)||n.set(t,[]),n.get(t).push({sideEffect:r,cancelEffect:a})}e.innerHTML=a.join("")}for(;;){for(let[t,r]of n){let n=e.querySelector(`*[${S}=${t}]`);for(let e of r)e.sideEffect(n),delete e.sideEffect}t=yield;for(let[t,r]of n){let n=e.querySelector(`*[${S}=${t}]`);for(;;){let e=r.pop();if(!e)break;e.cancelEffect(n)}}if(!t)break;for(let e of O(r,t,void 0,[]))if("string"!=typeof e){let[t,r,a]=e;n.has(t)||n.set(t,[]),n.get(t).push({sideEffect:r,cancelEffect:a})}}}}function N({strDate:e,todayStrDate:t,focusStrDate:r},n,a){let i=new Map(n.get(e)),s=!1,o=!1;for(let{unread:e}of i.values())o=!0,s|=e;return{strDate:e,hasAppointments:o,hasNoUnread:!s,inTodayMonth:l(e)==l(t),isToday:e==t,isFocus:e==r,handleClick:()=>a({url:"/appointments/day/",parameters:{strDate:e}})}}function*I({startDateTime:r,todayStrDate:a,focusStrDate:i},s,o){let l=function(t){for(;1!==e(t);)t-=864e5;return t}(r);for(let e=0;e<7;e++){let e=t(l);yield N({strDate:e,todayStrDate:a,focusStrDate:i},s,o),l=n(l)}}function*A({numberOfWeeks:e,todayStrDate:t,focusStrDate:r},n,i){let o=s(r);for(let s=0;s<e;s++)yield{cols:I({startDateTime:o,todayStrDate:t,focusStrDate:r},n,i)},o=a(o)}function W({numberOfWeeks:e,firstWeekIncludes:t},r){return{handleChange:e=>{r({url:"/calendar-grid/",parameters:{firstWeekIncludes:t,numberOfWeeks:e.target.value}})},value:e}}function M({dateTime:e,numberOfWeeks:r},n){return{handleChange:e=>{e.target.value&&n({url:"/calendar-grid/",parameters:{firstWeekIncludes:t(e.target.value),numberOfWeeks:r}})},value:t(e)}}function q({dateTime:e,numberOfWeeks:r},n){return{handleClick:()=>{n({url:"/calendar-grid/",parameters:{firstWeekIncludes:t(a(e)),numberOfWeeks:r}})}}}function j({dateTime:e,numberOfWeeks:r},n){return{handleClick:()=>{n({url:"/calendar-grid/",parameters:{firstWeekIncludes:t(i(e)),numberOfWeeks:r}})}}}function L({newEvents:e},t){if(e.length)return{size:e.length,handleClick:()=>{t({url:"/appointments/unread/",parameters:{}})}}}function $(){this.__templates={main:x(document.getElementById("calendar-grid_main").innerText),rows:x(document.getElementById("calendar-grid_rows").innerText)}}function U(){this.__templates=x(document.getElementById("appointments_list").innerText)}function P(){this.__templates=x(document.getElementById("day-appointments_main").innerText),this.__listHandler=new U}function H(){this.__templates=x(document.getElementById("unread-appointments_main").innerText),this.__listHandler=new U}function R(e){return new Set([...e.matchAll(/\b\w+\b/gi)].map((([e])=>e)).map(G).filter((e=>!!e)))}function z(e,t){let r,n=[];for(;e.length;)e:{for(let a of t){let t=a(e);if(t){[e,r]=t,n=n.concat(r);break e}}n.push(e[0]),e=e.slice(1)}return n.join("")}function F(e,t,r){if(e.startsWith(t))return[e.slice(t.length),r]}window.__COMPILER__=x,$.prototype={paint:async function({numberOfWeeks:e,firstWeekIncludes:r}){let n,a;e=e||5,r?(n=s(r),a=t(Date.now())):(n=Date.now(),a=t(n),r=a);let{view:i,newEvents:o}=await this.state;var l;this.__templates.main(this.anchorElement,{numberOfWeeksController:W({numberOfWeeks:e,firstWeekIncludes:r},this.navigateTo),firstDateIncludesController:M({dateTime:n,numberOfWeeks:e},this.navigateTo),previousWeekController:j({dateTime:n,numberOfWeeks:e},this.navigateTo),nextWeekController:q({dateTime:n,numberOfWeeks:e},this.navigateTo),unreadNavigation:L({newEvents:o},this.navigateTo),searchNavigation:(l=this.navigateTo,{handleClick:()=>{l({url:"/appointments/search/",parameters:{}})}})}).next(),this.__templates.rows(this.anchorElement.querySelector("*[data-id=calendar-grid_rows]"),{rows:A({numberOfWeeks:e,todayStrDate:a,focusStrDate:r},i,this.navigateTo)}).next()}},U.prototype={hydrate:async function(e,t,r){let n=function*(e,t,r){let n=e;if(r&&r.sort){let t=[...e];t=t.sort(c),n=t}for(let{strDate:e,strTime:r,strDescription:a,markUnread:i}of n)yield{strDate:e,strTime:r,markUnread:i,strDescription:a,handleClick:()=>{t({url:"/calendar/mutate/modify",parameters:{preferredDate:e,preferredTime:r}})}}}(t,e.navigateTo,r);this.__templates(e.anchorElement.querySelector("*[data-id=appointments_list]"),{appointments:n}).next()},clear:function(e){e.anchorElement.querySelector("*[data-id=appointments_list]").innerHTML=""}},P.prototype={paint:async function({strDate:e}){let{view:t}=await this.state,r=t.get(e),n=r&&r.size;this.__templates(this.anchorElement,{strDate:e,handleClick:()=>{this.navigateTo({url:"/calendar/mutate/create",parameters:{preferredDate:e}})},hasAppointments:n}).next(),n&&this.__listHandler.hydrate(this,function*(e,t){for(let[r,n]of e)yield{strDate:t,strTime:r,strDescription:n.description,markUnread:n.unread||!1}}(r,e))}},H.prototype={paint:async function(){let{view:e,newEvents:t}=await this.state,r=!!t.length;var n;this.__templates(this.anchorElement,{handleClick:(n=this,async function(){this.disabled=!0;try{await n.markRead(),history.back()}finally{this.disabled=!1}}),hasAppointments:r}).next(),r&&this.__listHandler.hydrate(this,function*(e,t){for(let{strDate:r,strTime:n}of e){let e=t.get(r).get(n);yield{strDate:r,strTime:n,strDescription:e}}}(t,e))}};const K=new Set("aeiouyh");function V(e,t,r){let n=t.length,a=t[n-1];if(e.startsWith(t)&&(e.length==n||e[n]!=a&&!K.has(e[n])))return[e.slice(n),r]}const J=[e=>e.startsWith("ch")?[e.slice(2),"C"]:e.startsWith("cc")?[e.slice(2),"x"]:e.startsWith("cq")?[e.slice(1),""]:e.startsWith("ci")||e.startsWith("ce")?[e.slice(1),"s"]:e.startsWith("c")?[e.slice(1),"k"]:void 0,e=>e.startsWith("gea")||e.startsWith("geo")?[e.slice(2),"j"]:e.startsWith("gi")||e.startsWith("gy")||e.startsWith("ge")?[e.slice(1),"j"]:e.startsWith("gui")||e.startsWith("guy")||e.startsWith("gue")?[e.slice(2),"g"]:void 0,e=>F(e,"qu","k"),e=>F(e,"q","k"),e=>F(e,"ph","f"),e=>F(e,"ille","Y"),e=>V(e,"on","O"),e=>V(e,"ain","I"),e=>V(e,"aim","I"),e=>F(e,"ai","e"),e=>V(e,"an","A"),e=>V(e,"am","A"),e=>V(e,"ein","I"),e=>V(e,"eim","I"),e=>F(e,"ei","e"),e=>V(e,"en","A"),e=>V(e,"em","A"),e=>V(e,"in","I"),e=>V(e,"im","I"),e=>F(e,"au","o"),e=>F(e,"eau","o"),e=>F(e,"eu","E"),e=>F(e,"ou","U"),e=>V(e,"un","I"),e=>V(e,"um","I"),e=>F(e,"y","i")],Q=[e=>F(e,"tiO","siO"),e=>F(e,"tiA","siA")],X=[e=>{if(e.length>1&&e[0]===e[1])return[e.slice(1),""]},e=>F(e,"h","")];function G(e){if(Y.has(e))return null;if("eau"==e)return e;if((e=(e=(e=(e=(e=(e=(e=(e=e.replaceAll("ç","ss")).replaceAll("ï","hi")).replaceAll("ë","he")).replaceAll("ü","hu")).replaceAll("ö","ho")).replaceAll("ä","ha")).normalize("NFKD")).replace(/[^\x20-\x7F]/g,"")).length<=1)return null;let t=e;return t=z(t,J),t=z(t,Q),t=z(t,X),t.length<=1?null:t}const Y=new Set(["au","aux","avec","ce","ces","dans","de","des","du","elle","en","et","eux","il","je","la","le","leur","lui","ma","mais","me","meme","mes","moi","mon","ne","nos","notre","nous","on","ou","par","pas","pour","qu","que","qui","sa","se","ses","son","sur","ta","te","tes","toi","ton","tu","un","une","vos","votre","vous","c","d","j","l","a","m","n","s","t","y","ete","etee","etees","etes","etant","suis","es","est","sommes","etes","sont","serai","seras","sera","serons","serez","seront","serais","serait","serions","seriez","seraient","etais","etait","etions","etiez","etaient","fus","fut","fumes","futes","furent","sois","soit","soyons","soyez","soient","fusse","fusses","fut","fussions","fussiez","fussent","ayant","eu","eue","eues","eus","ai","as","avons","avez","ont","aurai","auras","aura","aurons","aurez","auront","aurais","aurait","aurions","auriez","auraient","avais","avait","avions","aviez","avaient","eut","eumes","eutes","eurent","aie","aies","ait","ayons","ayez","aient","eusse","eusses","eut","eussions","eussiez","eussent","ceci","cela","cet","cette","ici","ils","les","leurs","quel","quels","quelle","quelles","sans","soi"]),Z={.3:[new Set("oO"),new Set("aA"),new Set("eE"),new Set("iI"),new Set("yiI")],.7:[new Set("vf"),new Set("bp"),new Set("td"),new Set("sz")]};function ee(e,t,r,n,a){let{x:i,y:s,upperBound:o}=a;if(r>o)return 1/0;if(n>=3)return 1/0;if(e.length){if(t.length){if(e[0]===t[0])return ee(e.slice(1),t.slice(1),r,n-1,a);{let i=function(e,t){if(e==t)return 0;for(let r in Z)for(let n of Z[r])if(n.has(e)&&n.has(t))return r;return 1}(e[0],t[0]);return r+=i,n+=i>=.5?1:0,Math.min(ee(e.slice(1),t.slice(1),r,n,a),ee(e,t.slice(1),r,n,a),ee(e.slice(1),t,r,n,a))}}return r+e.length}return i.length>=4&&r<=1&&i[0]==s[0]?r:r+t.length}function te(e,t,r){return e.length>t.length?te(t,e,r):ee(e,t,0,0,{x:e,y:t,upperBound:r})}function re(){this._SearchEngine__Calendar=new Map,this._SearchEngine__WordFrequencies=new Map,this._SearchEngine__DocumentCount=0}function ne(){this.__templates=x(document.getElementById("appointments-search_main").innerText),this.__listHandler=new U}function ae(e){switch(e){case"fullday":case"morning":case"afternoon":return e;default:return""}}function ie(e){switch(e){case"fullday":case"morning":case"afternoon":return"";default:return e}}function se(){this.__template=x(document.getElementById("calendar-mutation-form").innerText),this.__listHandler=new U}function oe(){se.call(this)}function le(){se.call(this)}function ce(){this.__templates={main:x(document.getElementById("authentication-pane").innerText)}}re.prototype={_SearchEngine__createKey:function({strDate:e,strTime:t}){return`${e} ${t}`},_SearchEngine__insertInVirtualCalendar:function({strDate:e,strTime:t,words:r}){let n=this._SearchEngine__createKey({strDate:e,strTime:t});this._SearchEngine__Calendar.set(n,r);for(let e of r){let t=this._SearchEngine__WordFrequencies.get(e)||0;this._SearchEngine__WordFrequencies.set(e,t+1)}this._SearchEngine__DocumentCount+=1},_SearchEngine__removeFromVirtualCalendar:function({strDate:e,strTime:t}){let r=this._SearchEngine__createKey({strDate:e,strTime:t});this._SearchEngine__Calendar.delete(r)},_SearchEngine__distanceToDocument(e,t){let r=this._SearchEngine__DocumentCount,n=0;for(let a of t)n+=(e.get(a)||0)*(1-this._SearchEngine__WordFrequencies.get(a)/r);return n},get acceptAppointment(){return function({strDate:e,strTime:t,strDescription:r}){let n=R(r);this._SearchEngine__insertInVirtualCalendar({strDate:e,strTime:t,words:n})}.bind(this)},get cancelAppointment(){return function({strDate:e,strTime:t}){this._SearchEngine__removeFromVirtualCalendar({strDate:e,strTime:t})}.bind(this)},get search(){return function({maximalCount:e,searchQuery:t}){let r,n=this;{const e=Date.now();let a=R(t);r=new Map;let i=-1/0;for(let e of a)for(let t of n._SearchEngine__WordFrequencies.keys()){let n=te(e,t);if(n<=Math.min(4,Math.max(e.length/2,t.length))){let e=r.get(t);e=null!=e&&isFinite(e)?e:1/0,e=Math.min(n,e),i=e>i?e:i,r.set(t,e)}}for(let e of[...r.keys()])r.set(e,1+i-r.get(e));console.log("** Took",Date.now()-e),console.log("** EXPENSION COMPUTED",r)}let a=0,i=[];for(let t of function*(e){e:for(;;){let t=[];try{for(let r=0;r<30;r++){let{value:r,done:n}=e.next();if(n)break e;t.push(r)}}finally{t.length&&(yield t)}}}(n._SearchEngine__Calendar.entries())){for(let[e,s]of t){let t=n._SearchEngine__distanceToDocument(r,s);t>a&&i.push({distance:t,key:e})}i.length>e&&(i.sort(((e,t)=>t.distance-e.distance)),i=i.slice(0,e),a=i[0])}return i}.bind(this)}},ne.prototype={paint:async function({defaultSearchQuery:e}){let{view:t}=await this.state,r=new re;for(let[e,n]of t)for(let[t,a]of n)r.acceptAppointment({strDate:e,strTime:t,strDescription:a.description});var n;this.__templates(this.anchorElement,{handleSubmit:(n=this,function(e){e.preventDefault();let a=this.querySelector("button"),i=this.search.value||"";if(i){a.disabled=!0;try{let e=r.search({maximalCount:7,searchQuery:i});n.__listHandler.hydrate(n,function*(e,t){for(let{key:r}of e){let e=r.substring(0,r.indexOf(" ")),n=r.substring(e.length+1),{unread:a,description:i}=t.get(e).get(n);yield{strDate:e,strTime:n,strDescription:i,markUnread:a}}}(e,t),{sort:!1})}finally{a.disabled=!1}}}),hasAppointments:!1,defaultSearchQuery:e}).next()}},se.prototype={paint:async function({preferredDate:e,preferredTime:t}){let r,{view:n}=await this.state;if(t=t||"",r="",(e=e||"")&&t){let a=n.get(e),i=new Map(a).get(t).description;r=i||r}this.__template(this.anchorElement,{handleSubmit:r=>{r.preventDefault(),function(e,t){let r=e.strDate.value||void 0,n=e.strTimeNumeric.value||void 0,a=e.strTimeRange.value||void 0,i=e.strDescription.value||"",s=!!e.cancel&&e.cancel.checked,o=a||n;(async()=>{let n=[e.strDate,e.strTimeNumeric,e.strTimeRange,e.strDescription,e.cancel,e.querySelector("button")],a=n.map((e=>e&&e.disabled));try{for(let e of n)e&&(e.disabled=!0);await t({strDate:r,strTime:o,strDescription:i,isCancelling:s})}finally{for(let e=0;e<n.length;e++)n[e]&&(n[e].disabled=a[e])}})()}(r.target,(async({strTime:r,strDate:n,strDescription:a,isCancelling:i})=>{i?await this.cancelEvent({strDate:n,strTime:r}):t&&e&&(r!==t||n!==e)?await this.editEvent({toCancel:{strTime:t,strDate:e},toCreate:{strTime:r,strDate:n,strDescription:a}}):await this.createEvent({strTime:r,strDate:n,strDescription:a}),history.back()}))},handleChange:a=>{let{strDate:i,strTime:s}=function(e,{preferredDate:t,preferredTime:r,preferredDescription:n}){let a=!!e.cancel&&e.cancel.checked;if(a)return e.strDate.value=t,e.strDescription.value=n,e.strTimeNumeric.value=ie(r),e.strTimeRange.value=ae(r),e.strTimeRange.disabled=!0,e.strDescription.disabled=!0,e.strDate.disabled=!0,e.strTimeNumeric.disabled=!0,{cancel:a};{let t=e.strTimeRange.value||void 0;return e.strTimeRange.disabled=!1,e.strDescription.disabled=!1,e.strDate.disabled=!1,t?(e.strTimeNumeric.disabled=!0,e.strTimeNumeric.required=!1):(e.strTimeNumeric.required=!0,e.strTimeNumeric.disabled=!1),{strTime:t||e.strTimeNumeric.value,strDate:e.strDate.value,cancel:a}}}(a.target.form,{preferredDate:e,preferredDescription:r,preferredTime:t});this.showConflicts({strTime:s,strDate:i},{preferredDate:e,preferredTime:t},n)},...this.templateParameters}).next(),function(e,{preferredDate:t,preferredTime:r,preferredDescription:n}){e.strDate.value=t,e.strDescription.value=n,e.strTimeNumeric.value=ie(r),e.strTimeRange.value=ae(r),e.strTimeRange.disabled=!1,e.strDescription.disabled=!1,e.strDate.disabled=!1,e.strTimeRange.value?(e.strTimeNumeric.disabled=!0,e.strTimeNumeric.required=!1):(e.strTimeNumeric.required=!0,e.strTimeNumeric.disabled=!1)}(this.anchorElement.querySelector("form[data-id=calendar-mutation-form]"),{preferredDate:e,preferredTime:t,preferredDescription:r}),this.showConflicts({preferredTime:t,preferredDate:e},{preferredDate:e,preferredTime:t},n)},showConflicts:function({strTime:e,strDate:t},{preferredDate:r,preferredTime:n},a){let i=[];t&&e&&(r==t&&n==e||(i=[...new Map(a.get(t)).entries()].filter((([t])=>{return(r=e)==(n=t)||"fullday"==r||"fullday"==n||("morning"==r?"afternoon"!=n&&n<"12:00":"morning"==n?"afternoon"!=r&&r<"12:00":"afternoon"==r?n>="12:00":"afternoon"==n&&r>="12:00");var r,n})).map((([e,r])=>({strTime:e,strDate:t,strDescription:r.description,markUnread:r.unread})))));let s=this.anchorElement.querySelector("*[data-id=conflicts_container]");i.length?(this.__listHandler.hydrate(this,i),s.classList.remove("hidden")):(s.classList.add("hidden"),this.__listHandler.clear(this))}},oe.prototype={templateParameters:{allowCancel:!1,pageTitle:"Créer un rendez-vous",submitText:"Créer"}},Object.setPrototypeOf(oe.prototype,se.prototype),le.prototype={templateParameters:{allowCancel:!0,pageTitle:"Modifier le rendez-vous",submitText:"Modifier"}},Object.setPrototypeOf(le.prototype,se.prototype),ce.prototype={paint:async function(){this.__templates.main(this.anchorElement,{handleSubmit:e=>{e.preventDefault(),function(e,t){let r=e.password.value||"",n=e.identity.value||"";(async()=>{let a=[e.password,e.identity,e.querySelector("button")];try{for(let e of a)e.disabled=!0;await t({userName:n,password:r})}catch(t){let{errorCode:r,errorMessage:n}=t;429===r||401===r||403===r?(e.querySelector("*[data-id=error-feedback-container]").classList.remove("hidden"),e.querySelector("*[data-id=error-feedback]").textContent=n,e.password.focus(),e.password.select()):console.error(t)}finally{for(let e of a)e.disabled=!1}})()}(e.target,(async({userName:e,password:t})=>{await this.authentify({userName:e,password:t}),this.navigateTo({url:"/calendar-grid/",parameters:{}})}))}}).next();let{userName:e}=this.authentifiedUser;e&&(this.anchorElement.querySelector("*[data-id=user-identity]").value=e)}},customElements.define("app-route-listener",class extends HTMLElement{constructor(){super()}connectedCallback(){window.addEventListener("popstate",(e=>this.handleHistoryChange({state:e.state}))),window.addEventListener("app-navigate",(({detail:e})=>this.handleNavigation(e))),(async()=>{await ue,this.__URLS=new Map([["/calendar-grid/",new $],["/appointments/day/",new P],["/appointments/unread/",new H],["/appointments/search/",new ne],["/calendar/mutate/create",new oe],["/calendar/mutate/modify",new le],["/authentication/",new ce]]),this.handleHistoryChange({})})()}handleHistoryChange({state:e,hash:t}){if(e)this.handleNavigation(e);else{if(null==t){t=location.hash.substring(1);try{t=atob(t)}catch(e){t=""}return this.handleHistoryChange({hash:t})}{let e=t.substring(0,t.indexOf("?")),r=new URLSearchParams(t.substring(e.length+1,t.length)),n=Object.fromEntries(r);this.handleHistoryChange({state:{url:e,parameters:n}})}}}handleNavigation({url:e,parameters:r}){console.log("NAVIGATION",e,r);e:{if(e){let t=this.__URLS.get(e);if(t){("/authentication/"==e?this.patchAuthenticationPrototype(t):this.patchPrototype(t)).paint(r).catch(console.error);break e}}this.emitNavigation({url:"/calendar-grid/",parameters:{numberOfWeeks:5,firstWeekIncludes:t(Date.now())}})}}emitNavigation({url:e,parameters:t}){dispatchEvent(new CustomEvent("app-navigate",{detail:{url:e,parameters:t}}))}handleAuthenticationError(e){return async function(){try{return await e(...arguments)}catch(e){let{errorCode:t,errorMessage:r}=e;throw 401!==t&&403!==t&&429!==t||this.emitNavigation({url:"/authentication/",parameters:{errorMessage:r}}),e}}.bind(this)}patchPrototype(e){let t=this,r={get state(){return t.handleAuthenticationError((()=>m.state))()},get authentify(){return t.handleAuthenticationError(m.authentify)},get createEvent(){return t.handleAuthenticationError(m.createEvent)},get cancelEvent(){return t.handleAuthenticationError(m.cancelEvent)},get editEvent(){return t.handleAuthenticationError(m.editEvent)},get markRead(){return t.handleAuthenticationError(m.markRead)},get navigateTo(){return function({url:e,parameters:r}){{let t=new URLSearchParams;for(let[e,n]of Object.entries(r))t.append(e,n);let n=`${e}?${t.toString()}`;history.pushState({url:e,parameters:r},"",`#${btoa(n)}`)}return t.emitNavigation({url:e,parameters:r})}},get anchorElement(){return document.getElementById("anchor-content")}};return Object.setPrototypeOf(r,e),r}patchAuthenticationPrototype(e){let t=this,r={get state(){throw"Property not available in Authentication process"},get authentify(){return m.authentify},get authentifiedUser(){return m.authentifiedUser},get createEvent(){throw"Property not available in Authentication process"},get cancelEvent(){throw"Property not available in Authentication process"},get editEvent(){throw"Property not available in Authentication process"},get markRead(){throw"Property not available in Authentication process"},get navigateTo(){return function({url:e,parameters:r}){{let t=new URLSearchParams;for(let[e,n]of Object.entries(r))t.append(e,n);let n=`${e}?${t.toString()}`;history.pushState({url:e,parameters:r},"",`#${btoa(n)}`)}return t.emitNavigation({url:e,parameters:r})}},get anchorElement(){return document.getElementById("anchor-content")}};return Object.setPrototypeOf(r,e),r}});const ue=new Promise((e=>{window.addEventListener("load",e)}))})()})();